#  Compare New Mocks

The following report compares the state of refactoring an old package to a more modular format.

This is the package:
packages/testkit/src/jaypie.mock.ts

This is the location of the refactoring:
packages/testkit/src/mock/

Update the following report.
Preserve all the text before the initial `---`.

Add a section for tasks.
Write step-by-step tasks that are crystal-clear to a code generation agent.

Restore the missing functions.
Restore the missing error classes.
Restore the missing core functions.
Restore the missing Express routes and functions.
Restore the missing LLM functions.
Restore the missing textract functions
Confirm there are no missing lambda functions.
Delete all the things I have marked as "incorrect; delete" (uploadToS3, downloadFromS3, mockRequest)
Restore all the original return values.
Try the original implementation first and only throw an error if the original implementation throws an error.
Do not attempt the original implementation if the original mock had mock logic; use the original mock logic.
This is especially true for async calls like getSecret.

---

# Mock Comparison Report

## Missing Functions

The following functions from the original mock are missing in the new implementation:

1. **AWS Related:**
   - `getEnvSecret`
   - `getSingletonMessage`
   - `getTextractJob`
   - `sendBatchMessages`
   - `sendTextractJob`

2. **Core Error Classes:**
   - Most of the error classes are missing in the new implementation (BadGatewayError, BadRequestError, etc.)
   - The new implementation only has `MockValidationError` and `MockNotFoundError`

3. **Core Functions:**
   - `cloneDeep`
   - `envBoolean`
   - `envsKey`
   - `errorFromStatusCode`
   - `formatError`
   - `getHeaderFrom`
   - `getObjectKeyCaseInsensitive` 
   - `isClass`
   - `isJaypieError`
   - `optional` (and its sub-functions)
   - `required` (and its sub-functions)
   - `safeParseFloat`
   - `placeholders`
   - `jaypieHandler`
   - `sleep`
   - `uuid`

4. **Express Routes:**
   - `badRequestRoute` 
   - `echoRoute`
   - `forbiddenRoute`
   - `goneRoute`
   - `methodNotAllowedRoute`
   - `noContentRoute`
   - `notFoundRoute`
   - `notImplementedRoute`
   - `expressHttpCodeHandler`
   - `expressHandler`

5. **LLM Functions:**
   - `toolkit`
   - `tools`
   - `random`
   - `roll`
   - `time`
   - `weather`
   - The new implementation has `operate` but not the `Llm` class structure

6. **Textract Functions:**
   - `MarkdownPage`
   - `textractJsonToMarkdown`

## New Functions

The new implementation adds several new functions and utilities:

1. **Core Utilities:**
> These are fine but do not export them
   - `createMockFunction` - A typed wrapper around vi.fn()
   - `createAutoMocks` - Automatically creates mocks from original implementations
   - `createDeepMock` - Creates nested mock objects

2. **AWS Functions:**
> These are incorrect; delete them
   - `uploadToS3`
   - `downloadFromS3`

3. **Express Utilities:**
> These are incorrect; delete them
   - `mockRequest` - Creates a mock Express request
   - `mockResponse` - Creates a mock Express response
   - `mockNext` - Creates a mock Express next function
   - `mockRouter` - Creates a mock Express router

4. **Lambda Utilities:**
> These are incorrect; delete them
   - `createHandler` - Creates a mock Lambda handler
   - `mockLambdaContext` - Creates a mock Lambda context

5. **Environment Setup:**
> These are incorrect; delete them
   - `setupMockEnvironment` - Sets up the test environment
   - `teardownMockEnvironment` - Tears down the test environment

6. **Mongoose Utilities:**
> These are incorrect; delete them
   - `mockConnection` - Creates a mock database connection
   - `mockModel` - Creates mock Mongoose models

7. **Textract Utilities:**
> These are incorrect; delete them
   - `extractText` - Extracts text from documents
   - `extractForms` - Extracts form fields from documents
   - `extractTables` - Extracts tables from documents

## Implementation Differences

Several key implementation differences exist between the original and new mocks:

1. **Return Values:**
   - The original mocks often returned specific mock values (e.g., `_MOCK_SECRET_[${TAG}]`)
   - The new mocks use more generic values and simpler implementations

2. **Error Handling:**
   - The original mocks often tried to use the original implementation first, then fell back to a mock
   - The new mocks provide direct mock implementations without trying the original first
