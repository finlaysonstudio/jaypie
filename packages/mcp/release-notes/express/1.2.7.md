---
version: 1.2.7
date: 2025-01-30
summary: Fix CORS OPTIONS preflight hanging with Lambda streaming
---

## Bug Fix

Fixed an issue where CORS OPTIONS preflight requests would hang indefinitely when using `createLambdaStreamHandler` with the `cors` middleware.

### Problem

When using Lambda response streaming, browser CORS preflight (OPTIONS) requests would hang because:
- The standard cors package's call to `res.end()` could get delayed by streaming's async behavior
- The Lambda response stream would stay open waiting for streaming data that never comes
- Browsers would timeout waiting for the preflight response

### Solution

The `cors` middleware now detects OPTIONS requests early and handles them synchronously:
- Sets all required CORS headers directly (Access-Control-Allow-Origin, Access-Control-Allow-Methods, etc.)
- Terminates the response immediately with a 204 No Content status
- Ensures the response stream doesn't enter streaming mode for preflight requests

### Usage

No changes required. The fix is automatic when using `cors` with `createLambdaStreamHandler`:

```typescript
import express from "express";
import { cors, createLambdaStreamHandler } from "@jaypie/express";

const app = express();
app.use(cors({ origin: "https://example.com" }));

// Streaming endpoint works correctly with CORS
app.post("/stream", (req, res) => {
  res.setHeader("Content-Type", "text/event-stream");
  res.write("data: hello\n\n");
  res.end();
});

export const handler = createLambdaStreamHandler(app);
```

### Related

- GitHub Issue: [#174](https://github.com/finlaysonstudio/jaypie/issues/174)
