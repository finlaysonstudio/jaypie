---
version: 1.2.8
date: 2025-02-01
summary: Fix CORS OPTIONS by calling flushHeaders() before res.end()
---

## Bug Fix

Fixed CORS OPTIONS preflight requests still hanging with Lambda streaming by calling `flushHeaders()` before `res.end()`.

### Problem

The fix in v1.2.7 called `res.end()` for OPTIONS requests but didn't explicitly flush headers first. In Lambda streaming mode:

1. `LambdaResponseStreaming._final()` closes the stream via `_wrappedStream.end()`
2. `_wrappedStream` is only created when `flushHeaders()` is called
3. Without explicit `flushHeaders()`, `_wrappedStream` could be null
4. The Lambda stream never closes, causing the response to hang

### Solution

Added explicit `res.flushHeaders()` call before `res.end()` in the CORS OPTIONS handler to ensure the Lambda stream wrapper is initialized before ending the response.

```typescript
res.statusCode = 204;
res.setHeader("Content-Length", "0");
res.flushHeaders();  // Initialize _wrappedStream before ending
res.end();
```

### Related

- GitHub Issue: [#178](https://github.com/finlaysonstudio/jaypie/issues/178)
- Follow-up to: [#174](https://github.com/finlaysonstudio/jaypie/issues/174)
