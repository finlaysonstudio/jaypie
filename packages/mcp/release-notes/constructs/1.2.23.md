---
version: 1.2.23
date: 2025-01-26
summary: Fix shared secrets not injecting env vars across constructs (Issue #158)
---

# @jaypie/constructs 1.2.23

## Bug Fix

### Shared Secrets Between Constructs (Issue #158)

Fixed an issue where secrets declared in multiple constructs (e.g., `JaypieQueuedLambda` and `JaypieNextJs`) would not properly inject `SECRET_*` environment variables or grant IAM permissions to the second construct.

**Root Cause**: `JaypieLambda` and `JaypieNextJs` were calling `resolveSecrets(scope, ...)` with their parent construct as the scope. This caused secrets to be cached per-construct rather than per-stack, so constructs couldn't share secrets.

**Fix**: Changed both `JaypieLambda` and `JaypieNextJs` to use `Stack.of(this)` as the scope for `resolveSecrets`. This ensures:
- Secrets are shared at the stack level across all constructs
- Each construct sets its own `SECRET_*` environment variables
- Each construct grants IAM permissions to its Lambda function

**Before** (broken):
```typescript
// JaypieQueuedLambda created secrets under its own namespace
// JaypieNextJs couldn't find or use those secrets
const jobProcessor = new JaypieQueuedLambda(this, "JobProcessor", {
  secrets: ["ANTHROPIC_API_KEY"],  // Created JobProcessorANTHROPICAPIKEY-xxx
});
const nextjsApp = new JaypieNextJs(this, "NextJsApp", {
  secrets: ["ANTHROPIC_API_KEY"],  // Missing env var and permissions!
});
```

**After** (fixed):
```typescript
// Both constructs share secrets at stack level
const jobProcessor = new JaypieQueuedLambda(this, "JobProcessor", {
  secrets: ["ANTHROPIC_API_KEY"],  // Creates shared secret
});
const nextjsApp = new JaypieNextJs(this, "NextJsApp", {
  secrets: ["ANTHROPIC_API_KEY"],  // Reuses same secret, gets env var + permissions
});
```
