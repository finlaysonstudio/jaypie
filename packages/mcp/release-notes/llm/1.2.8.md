---
version: 1.2.8
date: 2025-01-26
summary: Fix streaming crash after tool execution in Anthropic and OpenRouter adapters
---

## Bug Fixes

- **Streaming with Tools**: Fixed crash in `Llm.stream()` when tools are executed
  - Error: "Cannot read properties of undefined (reading 'map')"
  - Root cause: FunctionCall/FunctionCallOutput messages lack role/content fields
  - Fixed in AnthropicAdapter and OpenRouterAdapter buildRequest methods

## Technical Details

StreamLoop adds messages with `type: LlmMessageType.FunctionCall` and `type: LlmMessageType.FunctionCallOutput` to conversation history. These message types don't have `role` and `content` fields that adapters expected.

### AnthropicAdapter Changes
- FunctionCall messages converted to assistant message with `tool_use` block
- FunctionCallOutput messages converted to user message with `tool_result` block

### OpenRouterAdapter Changes
- FunctionCall messages converted to assistant message with `toolCalls` array
- FunctionCallOutput messages converted to `tool` role message

## Related

- Fixes GitHub Issue #165
